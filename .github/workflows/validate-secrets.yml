name: ğŸ” Validate GitHub Secrets

# Workflow pour valider la configuration des secrets GitHub
# Peut Ãªtre exÃ©cutÃ© manuellement ou lors de modifications de secrets

on:
  workflow_dispatch:
    inputs:
      check_level:
        description: 'Niveau de vÃ©rification'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - full
          - security
  schedule:
    # VÃ©rification hebdomadaire des secrets
    - cron: '0 6 * * 1'  # Tous les lundis Ã  6h UTC

env:
  NODE_VERSION: '22'

jobs:
  validate-secrets:
    name: ğŸ” Validation des Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” VÃ©rification des secrets essentiels
        run: |
          echo "ğŸ” VÃ©rification des secrets essentiels..."
          
          # Fonction pour vÃ©rifier un secret
          check_secret() {
            local secret_name=$1
            local secret_value=$2
            local is_required=${3:-true}
            
            if [ -z "$secret_value" ]; then
              if [ "$is_required" = "true" ]; then
                echo "âŒ SECRET MANQUANT (REQUIS): $secret_name"
                return 1
              else
                echo "âš ï¸  SECRET MANQUANT (OPTIONNEL): $secret_name"
                return 0
              fi
            else
              echo "âœ… SECRET CONFIGURÃ‰: $secret_name"
              return 0
            fi
          }
          
          # Compteurs
          missing_required=0
          missing_optional=0
          
          echo ""
          echo "ğŸ“‹ SECRETS CI/CD ESSENTIELS:"
          check_secret "NX_CLOUD_ACCESS_TOKEN" "${{ secrets.NX_CLOUD_ACCESS_TOKEN }}" false || ((missing_optional++))
          check_secret "SLACK_WEBHOOK_URL" "${{ secrets.SLACK_WEBHOOK_URL }}" false || ((missing_optional++))
          
          echo ""
          echo "ğŸ“‹ SECRETS DE DÃ‰PLOIEMENT:"
          check_secret "VERCEL_TOKEN" "${{ secrets.VERCEL_TOKEN }}" false || ((missing_optional++))
          check_secret "VERCEL_ORG_ID" "${{ secrets.VERCEL_ORG_ID }}" false || ((missing_optional++))
          check_secret "DOCKER_USERNAME" "${{ secrets.DOCKER_USERNAME }}" false || ((missing_optional++))
          check_secret "DOCKER_PASSWORD" "${{ secrets.DOCKER_PASSWORD }}" false || ((missing_optional++))
          
          echo ""
          echo "ğŸ“‹ SECRETS DE BASE DE DONNÃ‰ES:"
          check_secret "DATABASE_URL" "${{ secrets.DATABASE_URL }}" true || ((missing_required++))
          check_secret "REDIS_URL" "${{ secrets.REDIS_URL }}" true || ((missing_required++))
          
          echo ""
          echo "ğŸ“‹ SECRETS IA:"
          check_secret "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}" true || ((missing_required++))
          check_secret "ANTHROPIC_API_KEY" "${{ secrets.ANTHROPIC_API_KEY }}" false || ((missing_optional++))
          check_secret "GOOGLE_CLOUD_API_KEY" "${{ secrets.GOOGLE_CLOUD_API_KEY }}" false || ((missing_optional++))
          
          echo ""
          echo "ğŸ“‹ SECRETS DE SÃ‰CURITÃ‰:"
          check_secret "JWT_SECRET" "${{ secrets.JWT_SECRET }}" true || ((missing_required++))
          check_secret "ENCRYPTION_KEY" "${{ secrets.ENCRYPTION_KEY }}" true || ((missing_required++))
          check_secret "WEBHOOK_SECRET" "${{ secrets.WEBHOOK_SECRET }}" false || ((missing_optional++))
          
          echo ""
          echo "ğŸ“‹ SECRETS CLOUD:"
          check_secret "GCP_SERVICE_ACCOUNT_KEY" "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" false || ((missing_optional++))
          
          echo ""
          echo "ğŸ“Š RÃ‰SUMÃ‰:"
          echo "âœ… Secrets requis manquants: $missing_required"
          echo "âš ï¸  Secrets optionnels manquants: $missing_optional"
          
          if [ $missing_required -gt 0 ]; then
            echo ""
            echo "âŒ Ã‰CHEC: Des secrets requis sont manquants!"
            echo "ğŸ“– Consultez docs/github-secrets-setup.md pour la configuration"
            exit 1
          else
            echo ""
            echo "âœ… SUCCÃˆS: Tous les secrets requis sont configurÃ©s"
          fi

      - name: ğŸ” Validation avancÃ©e des formats
        if: github.event.inputs.check_level == 'full' || github.event.inputs.check_level == 'security'
        run: |
          echo "ğŸ” Validation des formats de secrets..."
          
          # Validation du format des tokens
          validate_format() {
            local secret_name=$1
            local secret_value=$2
            local expected_pattern=$3
            local description=$4
            
            if [ -n "$secret_value" ]; then
              if [[ $secret_value =~ $expected_pattern ]]; then
                echo "âœ… FORMAT VALIDE: $secret_name ($description)"
              else
                echo "âš ï¸  FORMAT SUSPECT: $secret_name ($description)"
              fi
            fi
          }
          
          echo ""
          echo "ğŸ“‹ VALIDATION DES FORMATS:"
          
          # Validation NX Cloud Token
          if [ -n "${{ secrets.NX_CLOUD_ACCESS_TOKEN }}" ]; then
            nx_token="${{ secrets.NX_CLOUD_ACCESS_TOKEN }}"
            if [[ $nx_token == nx_cloud_* ]]; then
              echo "âœ… FORMAT VALIDE: NX_CLOUD_ACCESS_TOKEN"
            else
              echo "âš ï¸  FORMAT SUSPECT: NX_CLOUD_ACCESS_TOKEN (devrait commencer par 'nx_cloud_')"
            fi
          fi
          
          # Validation Slack Webhook
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            slack_url="${{ secrets.SLACK_WEBHOOK_URL }}"
            if [[ $slack_url == https://hooks.slack.com/services/* ]]; then
              echo "âœ… FORMAT VALIDE: SLACK_WEBHOOK_URL"
            else
              echo "âš ï¸  FORMAT SUSPECT: SLACK_WEBHOOK_URL (devrait Ãªtre une URL Slack)"
            fi
          fi
          
          # Validation OpenAI API Key
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            openai_key="${{ secrets.OPENAI_API_KEY }}"
            if [[ $openai_key == sk-* ]]; then
              echo "âœ… FORMAT VALIDE: OPENAI_API_KEY"
            else
              echo "âš ï¸  FORMAT SUSPECT: OPENAI_API_KEY (devrait commencer par 'sk-')"
            fi
          fi
          
          # Validation Database URL
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            db_url="${{ secrets.DATABASE_URL }}"
            if [[ $db_url == postgresql://* ]] || [[ $db_url == postgres://* ]]; then
              echo "âœ… FORMAT VALIDE: DATABASE_URL"
            else
              echo "âš ï¸  FORMAT SUSPECT: DATABASE_URL (devrait Ãªtre une URL PostgreSQL)"
            fi
          fi
          
          # Validation Redis URL
          if [ -n "${{ secrets.REDIS_URL }}" ]; then
            redis_url="${{ secrets.REDIS_URL }}"
            if [[ $redis_url == redis://* ]] || [[ $redis_url == rediss://* ]]; then
              echo "âœ… FORMAT VALIDE: REDIS_URL"
            else
              echo "âš ï¸  FORMAT SUSPECT: REDIS_URL (devrait Ãªtre une URL Redis)"
            fi
          fi

      - name: ğŸ”’ Test de sÃ©curitÃ© des secrets
        if: github.event.inputs.check_level == 'security'
        run: |
          echo "ğŸ”’ Tests de sÃ©curitÃ© des secrets..."
          
          # VÃ©rification de la longueur des secrets
          check_secret_strength() {
            local secret_name=$1
            local secret_value=$2
            local min_length=${3:-32}
            
            if [ -n "$secret_value" ]; then
              local length=${#secret_value}
              if [ $length -ge $min_length ]; then
                echo "âœ… LONGUEUR SÃ‰CURISÃ‰E: $secret_name ($length caractÃ¨res)"
              else
                echo "âš ï¸  LONGUEUR FAIBLE: $secret_name ($length caractÃ¨res, minimum recommandÃ©: $min_length)"
              fi
            fi
          }
          
          echo ""
          echo "ğŸ“‹ VÃ‰RIFICATION DE LA FORCE DES SECRETS:"
          
          # VÃ©rification des secrets de sÃ©curitÃ©
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            check_secret_strength "JWT_SECRET" "${{ secrets.JWT_SECRET }}" 32
          fi
          
          if [ -n "${{ secrets.ENCRYPTION_KEY }}" ]; then
            check_secret_strength "ENCRYPTION_KEY" "${{ secrets.ENCRYPTION_KEY }}" 32
          fi
          
          if [ -n "${{ secrets.WEBHOOK_SECRET }}" ]; then
            check_secret_strength "WEBHOOK_SECRET" "${{ secrets.WEBHOOK_SECRET }}" 20
          fi
          
          echo ""
          echo "ğŸ” RECOMMANDATIONS DE SÃ‰CURITÃ‰:"
          echo "â€¢ Rotation des secrets tous les 90 jours"
          echo "â€¢ Utilisation de secrets diffÃ©rents par environnement"
          echo "â€¢ Monitoring des accÃ¨s aux secrets"
          echo "â€¢ RÃ©vocation immÃ©diate en cas de compromission"

      - name: ğŸ“Š GÃ©nÃ©ration du rapport
        if: always()
        run: |
          echo "ğŸ“Š GÃ©nÃ©ration du rapport de validation..."
          
          cat > secrets-validation-report.md << 'EOF'
          # ğŸ” Rapport de Validation des Secrets GitHub
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          **Niveau de vÃ©rification**: ${{ github.event.inputs.check_level || 'basic' }}
          
          ## ğŸ“‹ Statut des Secrets
          
          ### âœ… Secrets ConfigurÃ©s
          - Les secrets requis pour le fonctionnement de base sont prÃ©sents
          - La validation des formats a Ã©tÃ© effectuÃ©e
          
          ### ğŸ“– Documentation
          - Consultez `docs/github-secrets-setup.md` pour la configuration complÃ¨te
          - Utilisez `scripts/setup-github-secrets.ps1` pour l'automatisation
          
          ### ğŸ”„ Prochaines Actions
          - [ ] Planifier la rotation des secrets
          - [ ] Configurer les alertes de sÃ©curitÃ©
          - [ ] Tester les secrets en environnement de staging
          
          ---
          
          *Rapport gÃ©nÃ©rÃ© automatiquement par le workflow de validation*
          EOF
          
          echo "ğŸ“„ Rapport gÃ©nÃ©rÃ©: secrets-validation-report.md"

      - name: ğŸ“¤ Upload du rapport
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-validation-report
          path: secrets-validation-report.md
          retention-days: 30

      - name: ğŸ“¢ Notification Slack (succÃ¨s)
        if: success() && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#salambot-security'
          text: 'âœ… Validation des secrets GitHub rÃ©ussie'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“¢ Notification Slack (Ã©chec)
        if: failure() && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#salambot-security'
          text: 'âŒ Validation des secrets GitHub Ã©chouÃ©e - Action requise'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-audit:
    name: ğŸ›¡ï¸ Audit de SÃ©curitÃ©
    runs-on: ubuntu-latest
    if: github.event.inputs.check_level == 'security'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Scan des secrets dans le code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ”’ VÃ©rification des permissions
        run: |
          echo "ğŸ”’ VÃ©rification des permissions du repository..."
          
          # VÃ©rification des paramÃ¨tres de sÃ©curitÃ© recommandÃ©s
          echo "ğŸ“‹ ParamÃ¨tres de sÃ©curitÃ© recommandÃ©s:"
          echo "â€¢ Protection de la branche main activÃ©e"
          echo "â€¢ Revue de code obligatoire"
          echo "â€¢ Restrictions de push direct"
          echo "â€¢ Scan automatique des vulnÃ©rabilitÃ©s"
          echo "â€¢ Alertes de sÃ©curitÃ© activÃ©es"
          
          echo ""
          echo "âš ï¸  VÃ©rifiez manuellement ces paramÃ¨tres dans:"
          echo "   Settings > Branches > Branch protection rules"
          echo "   Settings > Security & analysis"

      - name: ğŸ“Š RÃ©sumÃ© de l'audit
        run: |
          echo "ğŸ“Š RÃ©sumÃ© de l'audit de sÃ©curitÃ©:"
          echo "âœ… Scan des secrets dans le code terminÃ©"
          echo "âœ… VÃ©rification des permissions effectuÃ©e"
          echo "ğŸ“– Consultez les artifacts pour les dÃ©tails complets"